<!DOCTYPE html>
<html lang="pt-BR" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Painel - TicTacMed</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            background: #f7f7fb;
        }

        header {
            padding: 16px 24px;
            background: #2b4c7e;
            color: #fff;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        main {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            padding: 24px;
        }

        .card {
            background: #fff;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
        }

        h2 {
            margin-top: 0;
            color: #2b4c7e;
        }

        label {
            display: block;
            margin: 12px 0 4px;
        }

        input, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccd6f6;
            border-radius: 8px;
        }

        .btn {
            margin-top: 16px;
            width: 100%;
            padding: 12px;
            border: 0;
            border-radius: 8px;
            background: #2b4c7e;
            color: #fff;
            font-weight: 600;
            cursor: pointer;
        }

        .msg {
            color: green;
            margin-bottom: 8px;
        }

        @media (max-width: 900px) {
            main {
                grid-template-columns: 1fr;
            }
        }

        /* Toast (top-right) */
        .toast {
            position: fixed;
            top: 16px;
            right: 16px;
            background: #2b4c7e;
            color: #fff;
            padding: 12px 16px;
            border-radius: 10px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 12px;
            opacity: 1;
            transform: translateY(0);
            transition: opacity .4s ease, transform .4s ease;
        }

        .toast.hide {
            opacity: 0;
            transform: translateY(-10px);
            pointer-events: none;
        }

        .toast-close {
            background: transparent;
            border: 0;
            color: #fff;
            font-size: 18px;
            line-height: 1;
            cursor: pointer;
            padding: 0 4px;
        }
    </style>
</head>
<body>
<header>
    <div>TicTacMed - Painel do atendente</div>
    <form action="/logout" method="post">
        <button class="btn" type="submit" style="width:auto; padding:8px 12px;">Sair</button>
    </form>
</header>
<main>
    <div id="welcomeToast" class="toast" th:if="${welcomeMsg}">
        <span th:text="${welcomeMsg}"></span>
        <button type="button" class="toast-close" onclick="dismissToast()" aria-label="Fechar">×</button>
    </div>
    <section id="patientSection" class="card">
        <h2>Cadastrar paciente</h2>
        <p class="msg" th:if="${patientMsg}" th:text="${patientMsg}"></p>
        <form method="post" action="/ui/patients">
            <label for="pname">Nome</label>
            <input id="pname" name="name" type="text" required/>
            <label for="pcontact">WhatsApp (com DDI, ex: 55DDDNUMERO)</label>
            <input id="pcontact" name="contact" type="text" placeholder="+55XXXXXXXXXXX" required/>
            <button class="btn" type="submit">Enviar código de validação</button>
        </form>

        <div th:if="${codeSent}">
            <hr/>
            <h3>Confirmar código</h3>
            <form method="post" action="/ui/patients/confirm">
                <label for="ccontact">WhatsApp do paciente</label>
                <input id="ccontact" name="contact" type="text" th:value="${contactPrefill}"
                       placeholder="+55XXXXXXXXXXX" required/>
                <label for="ccode">Código recebido no WhatsApp</label>
                <input id="ccode" name="code" type="text" maxlength="6" required/>
                <button class="btn" type="submit">Confirmar cadastro</button>
            </form>
        </div>
    </section>

    <section class="card">
        <h2>Novo agendamento</h2>
        <p class="msg" th:if="${scheduleMsg}" th:text="${scheduleMsg}"></p>
        <form method="post" action="/ui/schedules">
            <label for="patientContact">WhatsApp do paciente</label>
            <input id="patientContact" name="patientContact" type="text" placeholder="+55XXXXXXXXXXX" required/>
            <label for="medicineName">Medicamento</label>
            <input id="medicineName" name="medicineName" type="text" required/>
            <label for="startAt">Início</label>
            <input id="startAt" name="startAt" type="datetime-local" required/>
            <label for="days">Duração (em dias)</label>
            <input id="days" name="days" type="number" min="1" value="10" required/>
            <label for="frequency">Frequência</label>
            <select id="frequency" name="frequency" required>
                <option value="PT4H">A cada 4 horas</option>
                <option value="PT8H">A cada 8 horas</option>
                <option value="PT12H">A cada 12 horas</option>
                <option value="P1D">A cada 24 horas</option>
            </select>
            <button class="btn" type="submit">Criar agendamento</button>
        </form>
    </section>

    <section class="card" sec:authorize="hasRole('ADMIN')">
        <h2>Criar novo usuário da farmácia</h2>
        <p class="msg" th:if="${userMsg}" th:text="${userMsg}"></p>
        <form method="post" action="/ui/users">
            <label for="uusername">Usuário</label>
            <input id="uusername" name="username" type="text" required/>
            <label for="upassword">Senha</label>
            <input id="upassword" name="password" type="password" required/>
            <button class="btn" type="submit">Criar usuário</button>
        </form>
    </section>
</main>

<!-- Success Modal (shown when scheduleSuccess is true) -->
<div id="successModal" th:if="${scheduleSuccess}">
    <div style="position:fixed; inset:0; background:rgba(0,0,0,0.45);"></div>
    <div style="position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:#fff; padding:24px; border-radius:12px; width:90%; max-width:420px; box-shadow:0 8px 24px rgba(0,0,0,0.15);">
        <h3 style="margin-top:0; color:#2b4c7e;">Agendamento criado</h3>
        <p>O agendamento foi criado com sucesso.</p>
        <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:16px;">
            <button type="button" class="btn" style="width:auto; padding:8px 12px;"
                    onclick="window.location.href='/ui/dashboard'">Ir para o painel
            </button>
        </div>
        <p style="margin-top:12px; color:#666; font-size:12px;">Você será redirecionado automaticamente em alguns
            segundos…</p>
    </div>
</div>

<!-- Error Modal (shown when scheduleError is true) -->
<div id="errorModal" th:if="${scheduleError}">
    <div style="position:fixed; inset:0; background:rgba(0,0,0,0.45);"></div>
    <div style="position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:#fff; padding:24px; border-radius:12px; width:90%; max-width:460px; box-shadow:0 8px 24px rgba(0,0,0,0.15);">
        <h3 style="margin-top:0; color:#b00020;">Não foi possível criar o agendamento</h3>
        <p th:text="${scheduleErrorMsg}">Paciente não encontrado. Cadastre o paciente antes de criar agendamentos.</p>
        <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:16px;">
            <button type="button" class="btn" style="background:#e0e0e0; color:#333; width:auto; padding:8px 12px;"
                    onclick="closeModal('errorModal')">Fechar
            </button>
            <button type="button" class="btn" style="width:auto; padding:8px 12px;" onclick="focusPatientForm()">
                Cadastrar paciente agora
            </button>
        </div>
    </div>
</div>

<script>
    (function () {
        var modal = document.getElementById('successModal');
        if (modal) {
            setTimeout(function () {
                window.location.href = '/dashboard';
            }, 3000);
        }
        var toast = document.getElementById('welcomeToast');
        if (toast) {
            setTimeout(function () {
                toast.classList.add('hide');
                setTimeout(function () {
                    if (toast && toast.parentNode) toast.parentNode.removeChild(toast);
                }, 500);
            }, 4000);
        }
    })();

    function dismissToast() {
        var toast = document.getElementById('welcomeToast');
        if (toast) {
            toast.classList.add('hide');
            setTimeout(function () {
                if (toast && toast.parentNode) toast.parentNode.removeChild(toast);
            }, 300);
        }
    }

    function closeModal(id) {
        var el = document.getElementById(id);
        if (el && el.parentNode) el.parentNode.removeChild(el);
    }

    function focusPatientForm() {
        closeModal('errorModal');
        var section = document.getElementById('patientSection');
        if (section) {
            section.scrollIntoView({behavior: 'smooth'});
            var input = document.getElementById('pname');
            if (input) input.focus();
        }
    }
</script>

</body>
</html>